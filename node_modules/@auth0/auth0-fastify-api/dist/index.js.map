{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import type { FastifyInstance, FastifyReply, FastifyRequest } from 'fastify';\nimport fp from 'fastify-plugin';\n\nimport { ApiClient } from '@auth0/auth0-api-js';\n\ninterface AuthRouteOptions {\n  scopes?: string | string[];\n}\n\ndeclare module 'fastify' {\n  interface FastifyInstance {\n    requireAuth: (opts?: AuthRouteOptions) => (request: FastifyRequest, reply: FastifyReply) => Promise<void>;\n    auth0Client: ApiClient | undefined;\n  }\n\n  interface FastifyRequest {\n    user: Token;\n\n    getToken(): string | undefined;\n  }\n}\n\nexport interface Auth0FastifyApiOptions {\n  /**\n   * The auth0 domain (without https://)\n   */\n  domain: string;\n  /**\n   * The audience for the API\n   */\n  audience: string;\n  /**\n   * The optional client ID of the application.\n   * Required when using the `getAccessTokenForConnection` method.\n   */\n  clientId?: string;\n  /**\n   * The optional client secret of the application.\n   * At least one of `clientSecret` or `clientAssertionSigningKey` is required when using the `getAccessTokenForConnection` method.\n   */\n  clientSecret?: string;\n  /**\n   * The optional client assertion signing key to use.\n   * At least one of `clientSecret` or `clientAssertionSigningKey` is required when using the `getAccessTokenForConnection` method.\n   */\n  clientAssertionSigningKey?: string | CryptoKey;\n  /**\n   * The optional client assertion signing algorithm to use with the `clientAssertionSigningKey`.\n   * If not provided, it will default to `RS256`.\n   */\n  clientAssertionSigningAlg?: string;\n  /**\n   * Optional, custom Fetch implementation to use.\n   */\n  customFetch?: typeof fetch;\n}\n\nexport interface Token {\n  sub: string;\n  aud: string | string[];\n  iss: string;\n  scope?: string;\n}\n\nfunction validateScopes(token: Token, requiredScopes: string | string[]): boolean {\n  const scopes = Array.isArray(requiredScopes) ? requiredScopes : [requiredScopes];\n\n  // Extract token scopes (handling different formats)\n  let tokenScopes: string[] = [];\n\n  if (token.scope) {\n    tokenScopes = typeof token.scope === 'string' ? token.scope.split(' ') : token.scope;\n  }\n\n  // All required scopes must be present\n  return scopes.every((required) => tokenScopes.includes(required));\n}\nasync function auth0FastifyApi(fastify: FastifyInstance, options: Auth0FastifyApiOptions) {\n  if (!options.audience) {\n    throw new Error('In order to use the Auth0 Api plugin, you must provide an audience.');\n  }\n\n  const apiClient = new ApiClient({\n    domain: options.domain,\n    audience: options.audience,\n    clientId: options.clientId,\n    clientSecret: options.clientSecret,\n    clientAssertionSigningKey: options.clientAssertionSigningKey,\n    clientAssertionSigningAlg: options.clientAssertionSigningAlg,\n    customFetch: options.customFetch,\n  });\n\n  const replyWithError = (reply: FastifyReply, statusCode: number, error: string, errorDescription: string) => {\n    return reply\n      .code(statusCode)\n      .header(\n        'WWW-Authenticate',\n        `Bearer error=\"${error.replaceAll('\"', '\\\\\"')}\", error_description=\"${errorDescription.replaceAll('\"', '\\\\\"')}\"`\n      )\n      .send({\n        error: error,\n        error_description: errorDescription,\n      });\n  };\n\n  fastify.decorate('requireAuth', function (opts: AuthRouteOptions = {}) {\n    return async function (request: FastifyRequest, reply: FastifyReply) {\n      const accessToken = getToken(request);\n\n      if (!accessToken) {\n        return replyWithError(reply, 400, 'invalid_request', 'No Authorization provided');\n      }\n\n      try {\n        const token = await apiClient.verifyAccessToken({ accessToken }) as Token;\n\n        if (opts.scopes && !validateScopes(token, opts.scopes)) {\n          return replyWithError(reply, 403, 'insufficient_scope', 'Insufficient scopes');\n        }\n\n        request['user'] = token;\n      } catch (error) {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        if ((error as any).code === 'verify_access_token_error') {\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          return replyWithError(reply, 401, 'invalid_token', (error as any).message);\n        }\n\n        return replyWithError(reply, 401, 'invalid_token', 'Invalid token');\n      }\n    };\n  });\n\n  fastify.decorateRequest('getToken', function () {\n    return getToken(this);\n  });\n\n  fastify.decorate('auth0Client', apiClient);\n}\n\n\nexport default fp(auth0FastifyApi);\n\nfunction getToken(request: FastifyRequest): string | undefined {\n  const parts = request.headers.authorization?.split(' ');\n\n  return parts?.length === 2 && parts[0]?.toLowerCase() === 'bearer' ? parts[1] : undefined;\n}\n"],"mappings":";AACA,OAAO,QAAQ;AAEf,SAAS,iBAAiB;AA6D1B,SAAS,eAAe,OAAc,gBAA4C;AAChF,QAAM,SAAS,MAAM,QAAQ,cAAc,IAAI,iBAAiB,CAAC,cAAc;AAG/E,MAAI,cAAwB,CAAC;AAE7B,MAAI,MAAM,OAAO;AACf,kBAAc,OAAO,MAAM,UAAU,WAAW,MAAM,MAAM,MAAM,GAAG,IAAI,MAAM;AAAA,EACjF;AAGA,SAAO,OAAO,MAAM,CAAC,aAAa,YAAY,SAAS,QAAQ,CAAC;AAClE;AACA,eAAe,gBAAgB,SAA0B,SAAiC;AACxF,MAAI,CAAC,QAAQ,UAAU;AACrB,UAAM,IAAI,MAAM,qEAAqE;AAAA,EACvF;AAEA,QAAM,YAAY,IAAI,UAAU;AAAA,IAC9B,QAAQ,QAAQ;AAAA,IAChB,UAAU,QAAQ;AAAA,IAClB,UAAU,QAAQ;AAAA,IAClB,cAAc,QAAQ;AAAA,IACtB,2BAA2B,QAAQ;AAAA,IACnC,2BAA2B,QAAQ;AAAA,IACnC,aAAa,QAAQ;AAAA,EACvB,CAAC;AAED,QAAM,iBAAiB,CAAC,OAAqB,YAAoB,OAAe,qBAA6B;AAC3G,WAAO,MACJ,KAAK,UAAU,EACf;AAAA,MACC;AAAA,MACA,iBAAiB,MAAM,WAAW,KAAK,KAAK,CAAC,yBAAyB,iBAAiB,WAAW,KAAK,KAAK,CAAC;AAAA,IAC/G,EACC,KAAK;AAAA,MACJ;AAAA,MACA,mBAAmB;AAAA,IACrB,CAAC;AAAA,EACL;AAEA,UAAQ,SAAS,eAAe,SAAU,OAAyB,CAAC,GAAG;AACrE,WAAO,eAAgB,SAAyB,OAAqB;AACnE,YAAM,cAAc,SAAS,OAAO;AAEpC,UAAI,CAAC,aAAa;AAChB,eAAO,eAAe,OAAO,KAAK,mBAAmB,2BAA2B;AAAA,MAClF;AAEA,UAAI;AACF,cAAM,QAAQ,MAAM,UAAU,kBAAkB,EAAE,YAAY,CAAC;AAE/D,YAAI,KAAK,UAAU,CAAC,eAAe,OAAO,KAAK,MAAM,GAAG;AACtD,iBAAO,eAAe,OAAO,KAAK,sBAAsB,qBAAqB;AAAA,QAC/E;AAEA,gBAAQ,MAAM,IAAI;AAAA,MACpB,SAAS,OAAO;AAEd,YAAK,MAAc,SAAS,6BAA6B;AAEvD,iBAAO,eAAe,OAAO,KAAK,iBAAkB,MAAc,OAAO;AAAA,QAC3E;AAEA,eAAO,eAAe,OAAO,KAAK,iBAAiB,eAAe;AAAA,MACpE;AAAA,IACF;AAAA,EACF,CAAC;AAED,UAAQ,gBAAgB,YAAY,WAAY;AAC9C,WAAO,SAAS,IAAI;AAAA,EACtB,CAAC;AAED,UAAQ,SAAS,eAAe,SAAS;AAC3C;AAGA,IAAO,gBAAQ,GAAG,eAAe;AAEjC,SAAS,SAAS,SAA6C;AAC7D,QAAM,QAAQ,QAAQ,QAAQ,eAAe,MAAM,GAAG;AAEtD,SAAO,OAAO,WAAW,KAAK,MAAM,CAAC,GAAG,YAAY,MAAM,WAAW,MAAM,CAAC,IAAI;AAClF;","names":[]}